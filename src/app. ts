import { ChangeDetectionStrategy, Component, computed, signal, OnInit } from '@angular/core';

// 1. Define the data structure for a single bus journey
interface RouteSchedule {
  route: string;
  source: string;
  destination: string;
  departureTime: string; // Time the bus is scheduled to leave
  arrivalEstimate: string; // Estimated time of arrival
}

@Component({
  selector: 'app-root',
  standalone: true,
  template: `
    <!-- Main container: responsive, modern look using Tailwind CSS -->
    <div class="min-h-screen bg-gray-50 p-4 sm:p-8">
      
      <!-- Header Section -->
      <header class="mb-8 p-4 bg-white shadow-xl rounded-xl border-t-4 border-blue-600">
        <h1 class="text-3xl font-extrabold text-blue-700 tracking-tight">
          UJ Smart Transit Schedule
        </h1>
        <p class="text-gray-500 mt-1">
          Phase 1: Dynamic Campus Route Schedules
        </p>
      </header>

      <!-- Main Content Area: Schedule Viewer -->
      <main>
        <div class="bg-white p-6 rounded-xl shadow-2xl">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">
            Available Campus Routes
          </h2>
          
          <!-- Route Selection Dropdown (Filter) -->
          <div class="mb-6">
            <label for="route-select" class="block text-sm font-medium text-gray-700 mb-2">
              Filter by Route:
            </label>
            <select 
              id="route-select" 
              (change)="filterByRoute($event)"
              class="mt-1 block w-full md:w-1/2 lg:w-1/3 pl-3 pr-10 py-2 text-base border-gray-300 rounded-lg shadow-md transition duration-150 ease-in-out hover:border-blue-500"
            >
              <option value="All">All Routes</option>
              <!-- Loop through the unique routes we computed in the TypeScript class -->
              @for (route of availableRoutes(); track route) {
                <option [value]="route">{{ route }}</option>
              }
            </select>
          </div>

          <!-- Schedule Table: Responsive on smaller screens -->
          <div class="overflow-x-auto border border-gray-200 rounded-lg">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-blue-100">
                <tr>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">
                    Route
                  </th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">
                    Source Campus
                  </th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">
                    Destination Campus
                  </th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">
                    Departure Time
                  </th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">
                    Est. Arrival
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-100">
                <!-- Loop through the filtered list of schedules -->
                @for (item of filteredSchedule(); track item.departureTime) {
                  <tr class="hover:bg-blue-50 transition duration-100">
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-gray-900">{{ item.route }}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{{ item.source }}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{{ item.destination }}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-red-600 font-mono">{{ item.departureTime }}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-green-600 font-mono">{{ item.arrivalEstimate }}</td>
                  </tr>
                } @empty {
                  <tr>
                    <td colspan="5" class="px-4 py-4 text-center text-gray-500 italic">No schedule data available for this route.</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </main>

      <!-- Footer Section -->
      <footer class="mt-8 text-center text-sm text-gray-400">
        <p>UJ Smart Transit System | Angular & TypeScript Demo</p>
      </footer>
    </div>
  `,
  // Styles are kept minimal, relying primarily on Tailwind classes in the template
  styles: [`
    /* Ensure the table cell borders look clean */
    .divide-y th, .divide-y td {
      border-color: #f3f4f6;
    }
  `],
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class App implements OnInit {
  // 2. Data Store (Signal)
  // This signal holds the complete mock schedule data.
  private allSchedule = signal<RouteSchedule[]>([
    // Sample Routes based on UJ Campuses (APB, DFC, SWC, APK)
    { route: 'APB to DFC Shuttle', source: 'APB', destination: 'DFC', departureTime: '06:00', arrivalEstimate: '06:30' },
    { route: 'DFC to APK Express', source: 'DFC', destination: 'APK', departureTime: '06:45', arrivalEstimate: '07:10' },
    { route: 'SWC Commuter', source: 'SWC', destination: 'DFC', departureTime: '07:00', arrivalEstimate: '08:00' },
    { route: 'APB to DFC Shuttle', source: 'APB', destination: 'DFC', departureTime: '07:30', arrivalEstimate: '08:00' },
    { route: 'APK to DFC Express', source: 'APK', destination: 'DFC', departureTime: '08:00', arrivalEstimate: '08:25' },
    { route: 'SWC Commuter', source: 'DFC', destination: 'SWC', departureTime: '08:45', arrivalEstimate: '09:45' },
    { route: 'APB to DFC Shuttle', source: 'APB', destination: 'DFC', departureTime: '09:00', arrivalEstimate: '09:30' },
  ]);

  // 3. State Management (Signal)
  // This holds the user's current filter selection.
  private selectedRoute = signal<string>('All');

  // 4. Derived State (Computed Signal)
  // This automatically recalculates the list displayed in the table 
  // whenever the 'selectedRoute' or 'allSchedule' changes.
  filteredSchedule = computed(() => {
    const filter = this.selectedRoute();
    const data = this.allSchedule();

    if (filter === 'All') {
      return data;
    }
    // Filter the list to only include items matching the selected route name
    return data.filter(item => item.route === filter);
  });

  // 5. Computed Signal for Dropdown Options
  // Extracts all unique route names from the data for the filter dropdown.
  availableRoutes = computed(() => {
    const data = this.allSchedule();
    const routes = data.map(item => item.route);
    // Use Set to get only unique routes, and then sort them alphabetically
    return [...new Set(routes)].sort();
  });

  ngOnInit() {
    // This runs when the app starts. We can use it for data loading later.
    console.log("UJ Smart Transit System App Initialized and ready to display schedules.");
  }

  // 6. Event Handler
  // Updates the 'selectedRoute' signal when the user changes the dropdown.
  filterByRoute(event: Event) {
    const selectElement = event.target as HTMLSelectElement;
    this.selectedRoute.set(selectElement.value);
  }
}
